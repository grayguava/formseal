<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Decrypt Contact Message</title>

  <script src="../sodium.js"></script>

  <style>
    body {
      background:#ffffff;
      font-family:"Space Grotesk", sans-serif;
      display:flex;
      justify-content:center;
      padding-top:40px;
    }

    .container {
      width:700px;
      padding:25px;
      border:2px solid #00b78a;
      border-radius:6px;
      box-shadow:4px 4px #00b78a;
    }

    h2 {
      font-size:26px;
      font-weight:700;
      color:#00b78a;
      margin-bottom:20px;
      text-align:center;
    }

    label {
      font-weight:600;
      color:#06785d;
      display:block;
      margin-bottom:8px;
      margin-top:18px;
    }

    textarea, input {
      width:100%;
      padding:12px;
      font-size:15px;
      border:2px solid #00b78a;
      border-radius:6px;
      box-shadow:4px 4px #00b78a;
      outline:none;
      resize:vertical;
    }

    button {
      width:100%;
      padding:12px;
      margin-top:22px;
      font-size:16px;
      font-weight:700;
      border:2px solid #00b78a;
      background:white;
      border-radius:6px;
      cursor:pointer;
      box-shadow:4px 4px #00b78a;
    }

    button:active {
      transform:translate(3px,3px);
      box-shadow:0 0 #00b78a;
    }

    #outBox {
      margin-top:25px;
      padding:15px;
      background:#eaffe9;
      border-left:4px solid #00b78a;
      white-space:pre-wrap;
      min-height:120px;
      border-radius:6px;
      font-size:15px;
    }

    #out {
      color:#000;
      line-height:1.4;
    }

  </style>

</head>

<body>

  <div class="container">
    <h2>Decrypt Contact Message</h2>

    <label for="cipher">Ciphertext (Base64 URL-safe):</label>
    <textarea id="cipher" rows="5"></textarea>

    <label for="pub">Form Public Key (Base64 URL-safe):</label>
    <input id="pub" type="text">

    <label for="priv">Form Private Key (Base64 URL-safe):</label>
    <input id="priv" type="password">

    <button id="decBtn">Decrypt Message</button>

    <div id="outBox">
      <div id="out">Output will appear here...</div>
    </div>
  </div>


<script>
  function show(msg) {
    document.getElementById("out").textContent = msg;
  }

  document.getElementById("decBtn").addEventListener("click", async () => {
    try {
      await sodium.ready;

      const cipherB64 = document.getElementById("cipher").value.trim();
      const pubB64    = document.getElementById("pub").value.trim();
      const privB64   = document.getElementById("priv").value.trim();

      if (!cipherB64 || !pubB64 || !privB64) {
        show("❌ Missing ciphertext or keys.");
        return;
      }

      const cipher = sodium.from_base64(
        cipherB64,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );
      const pubKey = sodium.from_base64(
        pubB64,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );
      const privKey = sodium.from_base64(
        privB64,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );

      const msgBytes = sodium.crypto_box_seal_open(cipher, pubKey, privKey);

      if (!msgBytes) {
        show(
          "❌ Decryption failed.\n\nCheck that:\n" +
          "• The *form* keypair is correct\n" +
          "• Ciphertext is exactly copied from KV\n" +
          "• No trailing spaces or newlines"
        );
        return;
      }

      const plaintext = new TextDecoder().decode(msgBytes);
      show(plaintext);

    } catch (err) {
      show("Error: " + err);
    }
  });
</script>

</body>
</html>
