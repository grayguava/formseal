<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X25519 Keypair Generator (libsodium)</title>

  <script src="../sodium.js"></script>

  <style>
    body {
      background:#ffffff;
      font-family:"Space Grotesk", sans-serif;
      display:flex;
      justify-content:center;
      padding-top:40px;
    }

    .container {
      width:700px;
      padding:25px;
      border:2px solid #00b78a;
      border-radius:6px;
      box-shadow:4px 4px #00b78a;
    }

    h1 {
      font-size:26px;
      font-weight:700;
      color:#00b78a;
      text-align:center;
      margin-bottom:25px;
    }

    h2 {
      font-size:22px;
      font-weight:700;
      color:#06785d;
      margin-top:30px;
      margin-bottom:10px;
    }

    label {
      font-weight:600;
      color:#06785d;
      margin-top:20px;
      display:block;
    }

    input {
      width:100%;
      padding:12px;
      font-family:monospace;
      font-size:15px;
      border:2px solid #00b78a;
      border-radius:6px;
      box-shadow:4px 4px #00b78a;
      outline:none;
    }

    button {
      padding:12px;
      font-size:15px;
      font-weight:700;
      border:2px solid #00b78a;
      background:white;
      border-radius:6px;
      cursor:pointer;
      box-shadow:4px 4px #00b78a;
      margin-top:12px;
    }

    button:active {
      transform:translate(3px,3px);
      box-shadow:0 0 #00b78a;
    }

    .row {
      display:flex;
      gap:10px;
      margin-top:8px;
      align-items:center;
    }

    #importStatus {
      margin-top:10px;
      font-weight:600;
    }
  </style>
</head>

<body>

<div class="container">

  <h1>Generate X25519 Keypair</h1>

  <label>Public Key (Base64 URL-Safe)</label>
  <div class="row">
    <input id="pub" type="text" readonly />
    <button onclick="copyKey('pub')">Copy</button>
  </div>

  <label>Private Key (Base64 URL-Safe)</label>
  <div class="row">
    <input id="priv" type="text" readonly />
    <button onclick="copyKey('priv')">Copy</button>
  </div>

  <button onclick="downloadJSON()">Download keys.json</button>
  <button onclick="generate()">Regenerate Keypair</button>
  
  <h2>Import X25519 Private Key</h2>

  <div class="row">
    <input id="importPriv" placeholder="Paste private key here" />
    <button onclick="importKey()">Import</button>
  </div>

  <p id="importStatus"></p>

  <div class="row" style="margin-top: 10px;">
    <input id="importPub" type="text" readonly placeholder="Derived public key will appear here" />
    <button onclick="copyKey('importPub')">Copy</button>
  </div>

</div> <!-- container -->


<script>
    let currentPub = null;
    let currentPriv = null;

    async function generate() {
      console.log("generate() triggered");
      await sodium.ready;

      const kp = sodium.crypto_kx_keypair();

      if (currentPub) sodium.memzero(currentPub);
      if (currentPriv) sodium.memzero(currentPriv);

      currentPub = kp.publicKey;
      currentPriv = kp.privateKey;

      const pubB64 = sodium.to_base64(
        currentPub,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );

      const privB64 = sodium.to_base64(
        currentPriv,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );

      const decodedPub = sodium.from_base64(
        pubB64,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );

      const decodedPriv = sodium.from_base64(
        privB64,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );

      console.log("Pub bytes:", decodedPub.length);
      console.log("Priv bytes:", decodedPriv.length);

      const shared = sodium.crypto_scalarmult(decodedPriv, decodedPub);
      console.log("Shared secret length:", shared.length);

      document.getElementById("pub").value = pubB64;
      document.getElementById("priv").value = privB64;
    }

    function copyKey(id) {
      navigator.clipboard.writeText(document.getElementById(id).value);
    }

    function downloadJSON() {
      const pub = document.getElementById("pub").value;
      const priv = document.getElementById("priv").value;

      if (!pub || !priv) {
        alert("Generate a keypair first.");
        return;
      }

      const blob = new Blob(
        [JSON.stringify({ publicKey: pub, privateKey: priv }, null, 2)],
        { type: "application/json" }
      );

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "keys.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    generate();

    async function importKey() {
      await sodium.ready;

      const input = document.getElementById("importPriv").value.trim();
      const status = document.getElementById("importStatus");

      if (!input) {
        status.textContent = "Error: Key is empty.";
        status.style.color = "red";
        return;
      }

      if (input.includes("=")) {
        status.textContent = "Error: Key uses invalid padding (=).";
        status.style.color = "red";
        return;
      }

      if (!/^[A-Za-z0-9\-_]+$/.test(input)) {
        status.textContent = "Error: Invalid Base64 URL-safe characters.";
        status.style.color = "red";
        return;
      }

      let privBytes = null;

      try {
        privBytes = sodium.from_base64(
          input,
          sodium.base64_variants.URLSAFE_NO_PADDING
        );
      } catch {
        status.textContent = "Error: Base64 decode failed.";
        status.style.color = "red";
        return;
      }

      if (privBytes.length !== 32) {
        status.textContent = `Error: Decoded length ${privBytes.length}, expected 32.`;
        status.style.color = "red";
        return;
      }

      let derivedPub;
      try {
        derivedPub = sodium.crypto_scalarmult_base(privBytes);
      } catch {
        status.textContent = "Error: Invalid X25519 key.";
        status.style.color = "red";
        return;
      }

      status.textContent = "Success: Valid X25519 private key imported!";
      status.style.color = "green";

      window.importedPrivateKey = privBytes;
      window.importedPublicKey = derivedPub;

      const derivedPubB64 = sodium.to_base64(
        derivedPub,
        sodium.base64_variants.URLSAFE_NO_PADDING
      );

      document.getElementById("importPub").value = derivedPubB64;
    }
</script>

</body>
</html>
